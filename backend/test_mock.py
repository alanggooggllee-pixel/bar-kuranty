"""Test: run the analysis pipeline on sample transcripts.
Uses Gemini (free) or Claude, depending on which API key is set."""

import os
from analyzer import analyze_transcript, ANALYSIS_PROMPT

# Simulated transcript of a hostess call
MOCK_TRANSCRIPT_GOOD = """
Hostess: Добрый вечер, кафе-бар Куранты, меня зовут Мадина, чем могу помочь?
Гость: Здравствуйте, я хотел бы забронировать столик.
Hostess: Конечно! Звонок записывается для улучшения качества обслуживания. Подскажите, на какую дату и время вы хотели бы забронировать?
Гость: На эту субботу, часов на восемь вечера.
Hostess: Отлично, на субботу, 22 февраля, на 20:00. Сколько гостей будет?
Гость: Нас будет четверо.
Hostess: Понимаю. Вы предпочитаете зал, террасу или барную зону?
Гость: Лучше террасу, если можно.
Hostess: К сожалению, терраса на 20:00 уже занята. Могу предложить вам террасу на 19:00 или 21:00, либо прекрасный столик в основном зале с видом на сад. Что вам больше подойдёт?
Гость: Давайте на 21:00 на террасе.
Hostess: Замечательно! Итак, я забронировала для вас столик на террасе на субботу, 22 февраля, на 21:00, на четверых гостей. Всё верно?
Гость: Да, всё правильно.
Hostess: Отлично! Хотела бы уточнить — может быть, у вас есть особый повод? День рождения или другое торжество? Мы можем подготовить что-то особенное.
Гость: Нет, просто ужин с друзьями.
Hostess: Понимаю! Рекомендую заранее ознакомиться с нашим меню — у нас обновилось сезонное предложение. Также, если у кого-то из гостей есть аллергии или предпочтения по питанию, дайте нам знать заранее.
Гость: Хорошо, спасибо.
Hostess: Спасибо за звонок, будем рады вас видеть в субботу! До свидания!
Гость: До свидания!
"""

MOCK_TRANSCRIPT_BAD = """
Hostess: Алло, да?
Гость: Здравствуйте, это кафе Куранты?
Hostess: Да, это Куранты.
Гость: Я хотел бы забронировать столик на субботу.
Hostess: На сколько человек?
Гость: На четверых, часов на восемь.
Hostess: Так, сейчас посмотрю... На восемь нет ничего.
Гость: А что есть?
Hostess: Ну, не знаю, позвоните завтра, может что-то освободится.
Гость: А другое время?
Hostess: Ну попробуйте на шесть, может есть. Я точно не помню.
Гость: Ладно, а меню можно посмотреть где-то?
Hostess: В интернете посмотрите. Всё, до свидания.
"""


def run_test(transcript: str, label: str) -> None:
    """Run analysis on a transcript and print results."""
    print(f"\n{'='*60}")
    print(f"  {label}")
    print(f"{'='*60}")
    print(f"\n--- Транскрипт ---\n{transcript.strip()}\n")

    result = analyze_transcript(transcript)
    print(f"\n--- Результат анализа ---\n{result}\n")


if __name__ == "__main__":
    # Determine which API is available
    if os.environ.get("ANTHROPIC_API_KEY"):
        engine = "Claude (Anthropic)"
    elif os.environ.get("GEMINI_API_KEY"):
        engine = "Gemini (Google, бесплатно)"
    else:
        print("Ошибка: не задан API ключ.")
        print("Задайте один из:")
        print("  export GEMINI_API_KEY='...'   (бесплатно, aistudio.google.com)")
        print("  export ANTHROPIC_API_KEY='...' (платно, console.anthropic.com)")
        exit(1)

    print("Тест конвейера анализа звонков")
    print(f"Кафе-бар Куранты | Движок: {engine}\n")

    run_test(MOCK_TRANSCRIPT_GOOD, "ТЕСТ 1: Хороший звонок (ожидаем оценку A)")
    run_test(MOCK_TRANSCRIPT_BAD, "ТЕСТ 2: Плохой звонок (ожидаем оценку C/D)")

    print(f"\n{'='*60}")
    print("Тест завершён!")
    print(f"{'='*60}")
